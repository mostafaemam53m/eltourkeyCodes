!function(e){var t,a,n,i,r,o,l,c,g,h,s,u;function f(){u&&(u.clearRect(0,0,t.width,t.height),u.drawImage(l,0,0),n())}g=["text","color","alpha","space","size","rotation","xPos","yPos"],c={},l=null,o=e("#graph"),i=null,t=null,u=null,a=function(e){var t,a,n,i,r;for(r=(a=atob(e.split(",")[1])).length,t=new Uint8Array(r),n=i=0;i<=r-1;n=i+=1)t[n]=a.charCodeAt(n);return new Blob([t],{type:"image/png"})},r=function(){var e,t;return t=function(e){return e<10?"0"+e:e},""+(e=new Date).getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+" "+t(e.getHours())+t(e.getMinutes())+t(e.getSeconds())+".png"},s=function(){var n;null!=i&&((n=new FileReader).onload=function(){var i;(i=new Image).onload=function(){(t=document.createElement("canvas")).width=i.width,t.height=i.height,(u=t.getContext("2d")).drawImage(i,0,0),l=i,e.each(g,function(t,a){var n;n=e("#"+a),c[a]=n,n.on("input",function(){f()})}),o.html(""),o.append(t),e(t).on("click",function(){var n,i,l;(l=document.createElement("a")).download=r(),n=a(i=t.toDataURL("image/png")),l.href=URL.createObjectURL(n),o.append(l),setTimeout(function(){l.click(),e(l).remove()},100)}),f()},i.src=n.result},n.readAsDataURL(i))},h=function(){var e;return"rgba("+parseInt((e=c.color.val().match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i))[1],16)+","+parseInt(e[2],16)+","+parseInt(e[3],16)+","+c.alpha.val()+")"},n=function(){if(u){u.save();var e,a,n,i,r,o,l,g,s,f,p,d,v,w=parseFloat(c.rotation.val())||0;u.translate(t.width/2,t.height/2),u.rotate(w*Math.PI/180),u.translate(-t.width/2,-t.height/2),u.fillStyle=h(),f=c.size.val()*Math.max(15,Math.min(t.width,t.height)/25),u.font="bold "+f+'px -apple-system,"Helvetica Neue",Helvetica,Arial,"PingFang SC","Hiragino Sans GB","WenQuanYi Micro Hei",sans-serif',p=u.measureText(c.text.val()).width,d=Math.ceil((s=Math.sqrt(Math.pow(t.width,2)+Math.pow(t.height,2)))/(p+(r=u.measureText("what").width))),v=Math.ceil(s/(c.space.val()*f)/2);var m=t.width/100*c.xPos.val(),$=t.height/100*c.yPos.val();for(e=n=0,o=d;n<=o;e=n+=1)for(a=i=l=-v,g=v;l<=g?i<=g:i>=g;a=l<=g?++i:--i)u.fillText(c.text.val(),(p+r)*e+m,c.space.val()*f*a+$);u.restore()}},e("#image").on("change",function(){if("image/png"!==(i=this.files[0]).type&&"image/jpeg"!==i.type&&"image/gif"!==i.type)return alert("Only supports png, jpg, gif image formats");s()})}(jQuery);